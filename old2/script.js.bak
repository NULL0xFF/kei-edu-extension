function getMemberData(mailAddress = "") {
    var $form = jQuery("#memberSearchForm");
    $form[0].searchCsTitle.value = mailAddress;
    $form[0].searchListCnt.value = 100;
    jQuery("#pageIndex", $form).val(1);
    return new Promise(function (resolve, reject) {
        jQuery.ajax({
            url: "/user/member/selectMemberList.do",
            type: "post",
            data: $form.serialize(),
            datatype: "json",
            tryCount: 0,
            retryLimit: 3,
            async: true,
            success: function (data) {
                for (var i = 0; i < data.list.length; i++) {
                    if (data.list[i].cxMemberEmail === mailAddress)
                        resolve((({ csMemberSeq, csMemberId, csMemberName, cxMemberBirthday, cxMemberEmail, cxCompanyName, cxDepartmentName, cxDivisionCdName, csCertiType }) => ({ csMemberSeq, csMemberId, csMemberName, cxMemberBirthday, cxMemberEmail, cxCompanyName, cxDepartmentName, cxDivisionCdName, csCertiType }))(data.list[i]));
                }
            },
            error: function (xhr, status, error) {
                console.log(mailAddress);
                this.tryCount++;
                if (this.tryCount <= this.retryLimit) {
                    jQuery.ajax(this);
                    return;
                } else {
                    reject(xhr, status, error);
                }
            }
        });
    });
}

function getCourseList(memberData) {
    var $form = jQuery("#memberSearchForm");
    var result = "";
    var data = new Object();
    data.dspLinkMenuId = $("#dspLinkMenuId_member", $form).val();
    data.dspMenuId = $("#dspMenuId_member", $form).val();
    data.searchCsMemberSeq = memberData.csMemberSeq;
    return new Promise(function (resolve, reject) {
        jQuery.ajax({
            url: "/user/member/memberCourseHistoryPopup.do",
            type: "post",
            data: data,
            datatype: "html",
            tryCount: 0,
            retryLimit: 3,
            async: true,
            success: function (data) {
                result = cfn_trim(data.toString());
                jQuery("#applyRegArea").html(result);
                var $memberForm = jQuery("#memberSearchForm_member");
                $memberForm[0].searchListCnt_member.value = 100;
                $memberForm[0].searchCsMemberSeq_member.value = memberData.csMemberSeq;
                jQuery("#pageIndex_member", $memberForm).val(1);
                resolve(new Promise(function (resolve, reject) {
                    jQuery.ajax({
                        url: "/user/member/selectMemberCourseHistoryPopup.do",
                        type: "post",
                        data: $memberForm.serialize(),
                        datatype: "json",
                        tryCount: 0,
                        retryLimit: 3,
                        async: true,
                        success: function (data) {
                            for (var i = 0; i < data.list.length; i++) {
                                data.list[i] = (({ csYear, csCategoryName, csTitle, csCompletionYn, studyStartDate, studyEndDate, openStartDate, openEndDate }) => ({ csYear, csCategoryName, csTitle, csCompletionYn, studyStartDate, studyEndDate, openStartDate, openEndDate }))(data.list[i]);
                            }
                            resolve(data);
                        }, error: function (xhr, status, error) {
                            console.log(xhr);
                            console.log(memberData.cxMemberEmail);
                            this.tryCount++;
                            if (this.tryCount <= this.retryLimit) {
                                jQuery.ajax(this);
                                return;
                            } else {
                                reject(xhr, status, error);
                            }
                        }
                    });
                }));
            }, error: function (xhr, status, error) {
                console.log(memberData.cxMemberEmail);
                this.tryCount++;
                if (this.tryCount <= this.retryLimit) {
                    jQuery.ajax(this);
                    return;
                } else {
                    reject(xhr, status, error);
                }
            }
        });
    });
}

function saveAsJSON(fileName, output) {
    console.log("saveAsJSON(" + fileName + ", ... ) called");
    var fileContent = JSON.stringify(output);
    var bb = new Blob([fileContent], { type: "text/plain" });
    var a = document.createElement("a");

    a.download = fileName + "_" + new Date().toISOString() + ".json";
    a.href = window.URL.createObjectURL(bb);
    a.click();
}

function searchCourse(mailArray = [], fileName = "") {
    if (mailArray.length == 0) {
        var input = prompt("Input Mail Address(es)");
        mailArray = input.trim().replace(/\r/g, "").split("\n");
    }

    console.log("debug message");
    console.log(mailArray);

    const searchResult = new Promise(function (resolve, reject) {
        var list = new Array();
        mailArray.forEach(function (mailAddress, mailArrayIndex, mailArray) {
            new Promise(function (resolve, reject) {
                console.log("resolving member");
                getMemberData(mailAddress).then(function (memberData) {
                    console.log("resolving course");
                    getCourseList(memberData).then(courseList => {
                        var user = {
                            member: memberData,
                            course: courseList.list
                        };
                        resolve(user);
                    });
                });
            }).then(function (user) {
                console.log("resolved");
                list.push(user);
                if (mailArrayIndex === mailArray.length - 1)
                    resolve(list);
            });
        });
    });
    searchResult.then(async function (list) {
        await sleep(1000);
        console.log("saved");
        saveAsJSON(fileName, list);
    });

}

function sleep(ms) {
    return new Promise((r) => setTimeout(r, ms));
}
////////////////////////////////////////////////////////////////////////////////
console.log("KEI Admin Tools Extension Loaded");